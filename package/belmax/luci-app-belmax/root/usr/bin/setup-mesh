#!/bin/sh

mssid=$1
mkey=$2
hname=$3

if [ -z "$mssid" -o -z "$mkey" ]; then
    echo "Mesh failed, ssid [$mssid], mkey [$mkey]"
    exit 1
fi

uci set belmax.mesh.mesh_ssid=$mssid
uci set belmax.mesh.mesh_key=$mkey

if [ -n "$hname" ]; then
    uci set belmax.common.hostname=$hname
    uci set system.@system[0].hostname=$hname
fi

meshopt="wireless.wifinet2"

uci set $meshopt=wifi-iface
uci set $meshopt.device='radio1'
uci set $meshopt.mode='mesh'
uci set $meshopt.encryption='sae'
uci set $meshopt.mesh_id=$mssid
uci set $meshopt.mesh_fwding='1'
uci set $meshopt.mesh_rssi_threshold='0'
uci set $meshopt.key=$mkey
uci set $meshopt.network='lan wan'

uci commit
reload_config

sleep 5
echo "Mesh OK"
