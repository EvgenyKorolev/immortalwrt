/dts-v1/;

#include "ipq5018.dtsi"
#include "ipq5018-ess.dtsi"

#include <dt-bindings/gpio/gpio.h>
#include <dt-bindings/input/input.h>
#include <dt-bindings/leds/common.h>

/ {
    model = "Custom IPQ5018 Device with QCN6102";
    compatible = "custom,ipq5018-qcn6102", "qcom,ipq5018";

    aliases {
        serial0 = &blsp1_uart1;
        led-boot = &led_system;
        led-failsafe = &led_system;
        led-running = &led_system;
        led-upgrade = &led_system;
    };

    chosen {
        bootargs-append = " ubi.mtd=rootfs root=/dev/ubiblock0_1 rootfstype=ubifs";
        stdout-path = "serial0:115200n8";
    };

    keys {
        compatible = "gpio-keys";
        pinctrl-0 = <&button_pins>;
        pinctrl-names = "default";
        reset {
            label = "reset";
            gpios = <&tlmm 38 GPIO_ACTIVE_LOW>;
            linux,code = <116>; // KEY_POWER
        };
    };

    leds {
        compatible = "gpio-leds";

        led_system: system {
            function = LED_FUNCTION_POWER;
            color = <LED_COLOR_ID_RED>;
            gpios = <&tlmm 26 GPIO_ACTIVE_LOW>;
        };

        wlan2g {
            function = LED_FUNCTION_WLAN_2GHZ;
            color = <LED_COLOR_ID_GREEN>;
            gpios = <&tlmm 33 GPIO_ACTIVE_LOW>;
            linux,default-trigger = "phy0radio";
        };

        wlan5g {
            function = LED_FUNCTION_WLAN_5GHZ;
            color = <LED_COLOR_ID_BLUE>;
            gpios = <&tlmm 34 GPIO_ACTIVE_LOW>;
            linux,default-trigger = "phy1radio";
        };
    };

    reserved-memory {
        q6_mem_regions: q6_mem_regions@4b000000 {
            no-map;
            reg = <0x0 0x4b000000 0x0 0x3000000>;
        };
    };

    gpio-watchdog {
        compatible = "linux,wdt-gpio";
        gpios = <&tlmm 27 GPIO_ACTIVE_LOW>;
        hw_algo = "toggle";
        hw_margin_ms = <5000>;
        always-running;
    };
};

&switch {
    status = "okay";
    switch_mac_mode = <MAC_MODE_SGMII_CHANNEL0>;

    qcom,port_phyinfo {
        port@0 {
            port_id = <1>;
            mdiobus = <&mdio0>;
            phy_address = <7>;
        };
        port@1 {
            port_id = <2>;
            mdiobus = <&mdio1>;
            phy_address = <28>;
            port_mac_sel = "QGMAC_PORT";
        };
    };
};

&dp1 {
    status = "okay";
    label = "lan";
    phy-mode = "sgmii";
};

&dp2 {
    status = "okay";
    label = "wan";
    phy-handle = <&qca8081>;
};

&mdio0 {
    status = "okay";
};

&mdio1 {
    status = "okay";
    pinctrl-0 = <&mdio1_pins>;
    pinctrl-names = "default";
    qca8081: ethernet-phy@28 {
        compatible = "ethernet-phy-id004d.d101";
        reg = <28>;
        reset-deassert-us = <10000>;
        reset-gpios = <&tlmm 24 GPIO_ACTIVE_LOW>;
    };
};

&sleep_clk {
    clock-frequency = <32000>;
};

&xo_board_clk {
    clock-div = <4>;
    clock-mult = <1>;
};

// MAC0 -> GE Phy
&blsp1_uart1 {
    status = "okay";
    pinctrl-0 = <&serial_0_pins>;
    pinctrl-names = "default";
};

&crypto {
    status = "okay";
};

&cryptobam {
    status = "okay";
};

&prng {
    status = "okay";
};

&qfprom {
    status = "okay";
};

&qpic_bam {
    status = "okay";
};

&qpic_nand {
    pinctrl-0 = <&qpic_pins>;
    pinctrl-names = "default";
    status = "okay";

    partitions {
        status = "disabled";
    };

    nand@0 {
        compatible = "spi-nand";
        reg = <0>;
        #address-cells = <1>;
        #size-cells = <1>;

        nand-ecc-engine = <&qpic_nand>;
        nand-bus-width = <8>;

        partitions {
            compatible = "fixed-partitions";
            #address-cells = <1>;
            #size-cells = <1>;

            partition@0 {
                label = "0:TRAINING";
                reg = <0x00 0x80000>;
            };

            partition@80000 {
                label = "rootfs_1";
                reg = <0x80000 0x3e00000>;
            };

            partition@3e80000 {
                label = "rootfs";
                reg = <0x3e80000 0x3e00000>;
            };
        };
    };
};

// The most important part: support for QCN6102 over PCIe
&q6v5_wcss {
    status = "okay";
    memory-region = <&q6_mem_regions>;
    firmware-name = "ath11k/IPQ5018/hw1.0/q6_fw.mdt",
            "ath11k/IPQ5018/hw1.0/m3_fw.mdt",
            "ath11k/QCN6102/hw1.0/m3_fw.mdt";
};

&wifi0 {
    status = "okay";
    qcom,rproc = <&q6v5_wcss>;
    qcom,ath11k-calibration;
    qcom,ath11k-fw-memory-mode = <1>;
    qcom,bdf-addr = <0x4c400000>;
};

&tlmm {
    button_pins: button-state {
        pins = "gpio38";
        function = "gpio";
        drive-strength = <8>;
        bias-pull-up;
    };

    mdio1_pins: mdio-state {
        mdc-pins {
            pins = "gpio36";
            function = "mdc";
            drive-strength = <8>;
            bias-pull-up;
        };

        mdio-pins {
            pins = "gpio37";
            function = "mdio";
            drive-strength = <8>;
            bias-pull-up;
        };
    };

    qpic_pins: qpic-state {
        clock-pins {
            pins = "gpio9";
            function = "qspi_clk";
            drive-strength = <8>;
            bias-disable;
        };

        cs-pins {
            pins = "gpio8";
            function = "qspi_cs";
            drive-strength = <8>;
            bias-disable;
        };

        data-pins {
            pins = "gpio4", "gpio5", "gpio6", "gpio7";
            function = "qspi_data";
            drive-strength = <8>;
            bias-disable;
        };
    };

    serial_0_pins: uart0-state {
        pins = "gpio20", "gpio21";
        function = "blsp0_uart0";
        drive-strength = <8>;
        bias-disable;
    };
};